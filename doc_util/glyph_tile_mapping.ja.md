# NetHack 3.7 グリフ・タイルマッピング技術解説

NetHack の内部データ（グリフ）がどのようにタイルの索引に変換され、画像上で描画されるかの仕組みについて解説します。

---

## 1. エンコードされたグリフ (\G 形式)

NetHack 3.7 では、ステータス行やメッセージなどで「アイコン付きテキスト」を表示するために、`\G` で始まる特殊な文字列を使用します。

**例: `\G210C0F2B:100`**

*   **`\G`**: エンコードされたグリフの開始記号。
*   **最初の4桁の16進数**: セキュリティ用のランダム値（セッションごとに変わることがあります）。
*   **次の4桁の16進数 (`0F2B`)**: これが重要となる **グリフ番号 (Glyph Index)** です。
    *   `0x0F2B` = 10進数で **3883**。所持金などのアイコンに使用されます。
*   **`:`**: グリフデータと実データの区切り。
*   **`100`**: 実際に表示される数値やテキスト（例：所持金）。

---

## 2. グリフ番号からタイルインデックスへの変換

NetHack 3.7 におけるグリフとタイルの関係は、カテゴリごとのオフセットによって管理されています。

### 主要な定数 (NetHack 3.7 標準)
*   **NUMMONS**: 394 (モンスターの種類数。NetHack 3.7.0 ソースコードで確定)
*   **NUM_OBJECTS**: 453 (オブジェクトの種類数。プロジェクトの `tileMapping.js` での規定値)

### グリフとタイルのオフセット構造
内部的には `include/display.h` のオフセットと、`win/share/tilemap.c` のロジックによって以下のようにマップされます。

| グリフカテゴリ | グリフ開始オフセット | 対応するタイル (Tile Index) | 備考 |
| :--- | :--- | :--- | :--- |
| **Monsters (雄)** | `GLYPH_MON_MALE_OFF` (0) | `2 * mnum + (shifts * 2)` | モンスター番号 `mnum` と条件付きシフトの合計 |
| **Monsters (雌)** | `GLYPH_MON_FEM_OFF` (394) | `2 * mnum + 1 + (shifts * 2)` | 雄タイルの直後が雌タイルのペア |
| **Pets (雄)** | `GLYPH_PET_MALE_OFF` (788) | (Mon-M と同じ) | ペット表示用の雄タイル |
| **Pets (雌)** | `GLYPH_PET_FEM_OFF` (1182) | (Mon-F と同じ) | ペット表示用の雌タイル |
| **Invisible Mon** | `GLYPH_INVIS_OFF` (1576) | **813** (実測値) | 全モンスター(394種x2) + シフト(13種x2)の後 |
| **Detect (雄)** | `GLYPH_DETECT_MALE_OFF` (1577) | (Mon-M と同じ) | 被発見モンスター(雄) |
| **Detect (雌)** | `GLYPH_DETECT_FEM_OFF` (1971) | (Mon-F と同じ) | 被発見モンスター(雌) |
| **Body (死体等)** | `GLYPH_BODY_OFF` (2365) | (オブジェクト依存) | 死体はオブジェクトセクション（Tile 1272付近） |
| **Ridden (雄)** | `GLYPH_RIDDEN_MALE_OFF` (2759) | (Mon-M と同じ) | 騎乗されているモンスター(雄) |
| **Ridden (雌)** | `GLYPH_RIDDEN_FEM_OFF` (3153) | (Mon-F と同じ) | 騎乗されているモンスター(雌) |
| **Objects** | `GLYPH_OBJ_OFF` (3547) | **815** (実測値) | 不可視モンスターおよびダミー(2タイル)の後 |
| **CMAP** | `GLYPH_CMAP_OFF` (4000) | **1270** (推計値) | 全オブジェクト(453枚) + オブジェクトシフトの後 |

> [!IMPORTANT]
> **条件付きシフト (Conditional Shifts):**
> `tilemap.c` には、特定のモンスターやオブジェクトの後に「予備のタイル」や「特殊な置換タイル」を挿入するためのロジックがあります。
> - **モンスターセクション:** 13 個のシフト（計 26 タイル分）が挿入されます。これにより、本来 `394 * 2 = 788` で終わるはずのモンスタータイルが `788 + 26 = 814` まで延長されます。
> - **主なシフト対象:** `hell hound` (Cerberus用), `shocking sphere` (beholder用), `vampire leader` (vampire mage用) など。
>
> このシフトを正確に再現しないと、オブジェクト（Tile 815〜）や CMAP の表示が数マス分ずれることになります。修正後の `tileMapping.js` ではこのロジックを完全に再現しています。

---

## 3. 実装システム (Wasm ポート専用)

本プロジェクトでは、`WebGameCoreSystem` を拡張した混合レンダリングエンジンによってタイルと文字を同時に処理します。

### 混合レンダリングエンジン: `fontPrintControl_with_glyph.js`
このクラスは、渡された文字コードが「文字」か「グリフID」かを判定し、適切なイメージソースから描画を行います。

#### 初期化パラメータ
`new fontPrintControl_with_glyph(...)` には以下のリソースを渡します。
- **フォント**: ASCII用イメージ、漢字用イメージ、およびそれぞれのサイズ。
- **タイル**: タイルセット画像 (`tilePtn`)、タイルサイズ (`tw`, `th`)。
- **マッピング**: `tileMapping.js` で生成された `mappingTable`。

#### 描画メソッド
- **`print(str, x, y)`**: 文字列を解析し、フォントまたはタイルを等幅で描画します。
- **`putchr(str, x, y, scale)`**: 任意のスケーリングを適用して描画します。

---

## 4. 文字とグリフの混在表示 (混合レンダリング)

実装では、Unicode の未使用領域や特定範囲にグリフIDを仮想的に割り当てることで、一つの文字列内で文字とアイコンを混在させています。

### 数値範囲と判定ロジック
`fontPrintControl_with_glyph.js` の `charCodeToLoc` 関数における判定基準は以下の通りです。

| 種類 | 文字コード・範囲 (10進数) | 実装上の処理 |
| :--- | :--- | :--- |
| **ASCII** | `0` ～ `255` | ASCII フォント画像を使用 |
| **グリフ (Glyphs)** | `256` ～ `11,999` | `mappingTable` を参照してタイル画像を使用 |
| **半角カナ** | `0xFF60` ～ `0xFF9F` | ASCII フォント画像の特定のオフセットを使用 |
| **漢字 (Unicode)** | `12,352` (0x3040) ～ | 日本語フォントビットマップ (utfmap) を使用 |

### 実装のメリット
- **単一の描画命令**: `UIManager` は「文字かタイルか」を意識せずに、`\G` からデコードされたコードを含む文字列を `print()` に渡すだけで描画が完結します。
- **自動位置調整**: タイルとフォントの高さが異なる場合も、エンジン内でベースラインの調整が可能です。

---

## 5. UI への組み込み指針

### モニター表示 (nhPrintGlyph)
`UIManager.js` の `nhPrintGlyph` 内で、受け取ったグリフIDをそのまま `fontPrintControl_with_glyph` に渡すことで、マップ上のタイル表示を実現します。

### ステータス表示 (BL_GOLD 等)
ステータス更新文字列に `\G` が含まれる場合、以下の手順でパースして描画します：

1.  `\G` 直後の 4〜8 文字目からヘキサ値を読み取り、10進数のグリフIDに変換。
2.  `String.fromCharCode(glyphId)` を使用して、グリフIDを一つの「文字」として扱う文字列を作成。
3.  数値テキストと連結して `print()` に渡す。

#### 実装例：
```javascript
// \Gxxxx0F2B:100 という文字列を受け取った場合
const glyphId = parseInt("0F2B", 16); // 3883
const valText = "100";

// グリフを文字コードとして埋め込んだ混合文字列を作成
const mixedStr = String.fromCharCode(glyphId) + " " + valText;

// 混合レンダリングエンジンで描画
tprint.print(mixedStr, x, y); 
```

---

## 参考ファイル
*   `include/display.h`: グリフ・オフセット定義
*   `win/share/tilemap.c`: タイルマッピングのロジック
*   `Release/rogue/UI/fontPrintControl_with_glyph.js`: 混合レンダリングエンジン
*   `Release/param/tileMapping.js`: マッピングテーブル定義
