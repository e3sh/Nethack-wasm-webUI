# NetHack メッセージ翻訳フロー解説

`rogue/UI/trancelate.js` における翻訳エンジンの仕組みを解説します。このドキュメントは、辞書の編集や新しい翻訳ルールの追加時の参考にしてください。

## 1. 翻訳の優先順位

翻訳エンジン `get_translation_data(msg)` は、以下の順番でマッチングを試みます。一致した時点でその翻訳結果を返し、後続の処理は行われません。

1.  **完全一致 (`nhMessage_jp.js`)**
    - メッセージ全体が原文と一致する場合。システム固定メッセージや長文の引用に使用。
2.  **単語・エンティティ一致 (`nhMessage_entity.js`)**
    - モンスター名や短い単語。冠詞（a, the）や複数形の `s` を除いた状態でのマッチングも試みます。
3.  **アイテム名のパース・翻訳 (`nhMessage_items.js`)**
    - 「blessed +1 long sword」のような複雑なアイテム表記を分解・再構成します。
4.  **正規表現パターンマッチング (`nhMessage_pattern.js`)**
    - 変数を含む文章（例: `You hit the $1.`）を置換・翻訳します。

---

## 2. 各辞書の役割

| 辞書ファイル | 役割 | 編集のタイミング |
| :--- | :--- | :--- |
| `nhMessage_jp.js` | 全文一致の翻訳データ | 特定の文章をまるごと日本語に変えたい時 |
| `nhMessage_entity.js` | モンスター名、ステータス、汎用単語 | 新しいモンスター名の追加や、共通語の修正 |
| `nhMessage_items.js` | アイテム名専用の辞書・パターン | アイテム固有の名称や、「〜の屍」といったパターンを定義する時 |
| `nhMessage_pattern.js` | 正規表現による文章パターン | 「$1を攻撃した」のような、変数を含むログを追加・修正する時 |

---

## 3. 翻訳の仕組み（テクニカル）

### アイテム名の分解 (Item Parsing)
アイテム名は以下の要素に分解されてから、それぞれが個別に翻訳され、最後に日本語の語順で再構成されます。
`[数量] [祝福状態] [劣化/侵食] [強化値] [本体名] [追加情報]`

### 再帰的翻訳 (Recursive Translation)
`nhMessage_pattern.js` などでキャプチャされたグループ（例: `$1`）は、再度翻訳エンジンにかけられます。
- 例: `You hit the orc.`
  1. パターン `You hit the (.*).` にマッチ。
  2. `$1` （= `orc`）を個別に翻訳エンジンへ送る。
  3. `orc` が `オーク` と翻訳される。
  4. 最終的に `オークを攻撃した。` が生成される。

## 4. 辞書編集のアドバイス

-   **アイテム名は専用辞書へ**: アイテムの本体名は `nhMessage_entity.js` よりも `nhMessage_items.js` 内の `nhMessage_entity_items` に書くことで、アイテムとしての文脈に合った訳（例: 鉄 -> 鉄の〜）を優先させることができます。
-   **パターンの重複に注意**: 正規表現パターンは上から順に試行されるため、より具体的なパターンを上に、汎用的なパターンを下に配置してください。
-   **原文の確認**: 翻訳が上手くいかない場合は、`nhMessage_org.js` を見て、翻訳エンジンが受け取っている正確な英文を確認してください。
